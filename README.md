# 私域商城系统

私域商城系统是一个基于PHP的现代化B2C电商平台，集成了微信小程序、多种支付方式、短信服务等完整电商功能。

## 🎯 系统功能

### 核心功能模块
- **用户管理** - 会员系统、权限管理、用户中心、邮箱通知
- **商品管理** - 商品分类、SKU管理、库存管理、批量操作
- **订单管理** - 订单处理、支付、发货、退货、状态跟踪
- **支付系统** - 微信支付、支付宝等多渠道支付
- **小程序支持** - 完整的微信小程序API接口
- **营销功能** - 促销活动、优惠券、会员等级、数据分析
- **物流管理** - 电子面单、快递查询、批量发货
- **短信服务** - 腾讯云短信验证码和通知
- **邮件服务** - SMTP邮件发送、模板管理、通知场景配置
- **后台管理** - 完整的后台管理系统、数据统计、日志记录

### 技术架构
- **后端**：PHP 8.0+，MySQL 8.0+
- **前端**：原生PHP模板 + React (可选)
- **安全**：CSRF防护、SQL注入防护、XSS防护
- **缓存**：支持Redis缓存（可选）

## 📋 系统要求

### 服务器要求
- PHP 8.0 或更高版本
- MySQL 8.0 或更高版本
- Apache/Nginx Web服务器
- 支持HTTPS（推荐）

### PHP扩展要求
```bash
- PDO MySQL扩展
- JSON扩展  
- MBString扩展
- GD图像处理扩展
- cURL扩展
- OpenSSL扩展
```

## 🚀 快速安装

### 方法一：在线安装（推荐）
1. 上传源码到服务器
2. 设置Web根目录为项目根目录
3. 访问 `http://yourdomain.com/install.php`
4. 按照安装向导完成配置

### 方法二：手动安装
1. 导入数据库：执行 `database/schema.sql`
2. 复制配置文件：`config/config.php.example` → `config/config.php`
3. 修改数据库配置
4. 设置目录权限：
   ```bash
   chmod 755 public/uploads/
   chmod 644 config/config.php
   ```

## 📊 数据库结构

### 核心数据表
- `users` - 用户表
- `products` - 商品表  
- `orders` - 订单表
- `payments` - 支付记录表
- `site_settings` - 系统配置表
- `categories` - 商品分类表
- `cart` - 购物车表
- `addresses` - 收货地址表

### 通知相关表
- `email_config` - 邮箱配置表
- `email_notifications` - 邮件通知设置表
- `email_logs` - 邮件发送日志表

### 小程序相关表
- `user_tokens` - 用户Token表
- 小程序配置在 `site_settings` 表中

### 会员和营销表
- `member_levels` - 会员等级表
- `marketing_activities` - 营销活动表
- `freight_templates` - 运费模板表
- `express_configs` - 快递配置表
- `payment_channels` - 支付通道表

## 🔒 安全特性

### 安全防护
- CSRF Token防护
- SQL注入防护（PDO预处理）
- XSS跨站脚本防护
- 文件上传安全验证
- 密码加密存储（Bcrypt）
- 请求频率限制

### 数据安全
- 敏感信息加密存储
- 数据库连接安全配置
- HTTPS强制重定向
- 安全响应头设置

## 📱 小程序集成

### 小程序功能
- 微信登录授权
- 商品浏览和搜索
- 购物车管理
- 订单创建和支付
- 用户订单管理
- 收货地址管理

### API接口
```
POST /api/miniprogram/login          # 小程序登录
GET  /api/miniprogram/products       # 商品列表
GET  /api/miniprogram/product/detail  # 商品详情
POST /api/miniprogram/order/create   # 创建订单
POST /api/miniprogram/order/pay      # 小程序支付
GET  /api/miniprogram/orders         # 用户订单
POST /api/miniprogram/order/cancel   # 取消订单
```

## 💳 支付集成

### 支持的支付方式
- **微信支付** - Native支付、JSAPI支付
- **支付宝** - 网页支付、App支付
- **多商户支持** - 支持多个支付通道

### 支付流程
1. 创建支付订单
2. 生成支付参数
3. 用户支付
4. 异步回调处理
5. 订单状态更新

## 📧 短信服务

### 短信场景
- 用户注册验证码
- 登录验证码
- 订单确认通知
- 支付成功通知
- 发货通知
- 退款通知

### 配置说明
在后台管理系统中配置腾讯云短信服务参数：
- SecretId/SecretKey
- SDK AppID
- 短信签名
- 各场景模板ID

## 📬 邮件服务

### 邮件通知场景
- **用户注册** - 发送欢迎邮件
- **订单创建** - 订单确认通知
- **支付成功** - 支付完成通知
- **订单发货** - 发货通知
- **订单完成** - 确认收货通知
- **订单取消** - 订单取消通知
- **密码重置** - 密码重置提醒
- **库存预警** - 商品库存不足提醒

### 邮件配置
在后台 `/admin/email/config` 中配置SMTP参数：
- SMTP服务器地址和端口
- 邮箱账号和密码
- 加密方式（SSL/TLS）
- 发件人信息

### 模板管理
- 支持在线编辑邮件模板
- 支持变量替换（如用户名、订单号等）
- 支持HTML和纯文本格式
- 实时预览功能

### 邮件统计
- 发送成功率统计
- 各场景发送量统计
- 发送失败日志分析
- 邮件阅读状态跟踪

## 🔧 后台管理

### 管理功能
- **控制台** - 数据统计、系统概览
- **用户管理** - 用户信息、权限管理
- **商品管理** - 商品管理、分类管理、库存管理
- **订单管理** - 订单处理、状态跟踪、批量操作
- **营销活动** - 促销活动、优惠券、数据分析
- **会员等级** - 会员等级设置、权益管理
- **支付通道** - 支付配置、通道管理
- **物流管理** - 快递配置、电子面单、发货管理
- **通知管理**
  - 短信设置、短信统计
  - 邮箱配置、邮件通知、邮件日志、邮件统计
- **运费模板** - 配送规则、费用计算
- **系统设置** - 网站配置、功能开关

### 访问地址
- 后台地址：`http://yourdomain.com/admin`
- 默认管理员：admin / 安装时设置的密码

## 🐛 常见问题

### 安装问题
1. **数据库连接失败**：检查数据库配置和权限
2. **文件权限错误**：设置正确的目录权限
3. **PHP版本过低**：升级到PHP 8.0+

### 小程序问题
1. **小程序功能未开启**：在后台设置中开启小程序功能
2. **API接口报错**：检查小程序配置参数
3. **Token过期**：重新登录获取新Token

### 支付问题
1. **支付失败**：检查支付通道配置
2. **回调处理失败**：检查服务器网络和配置

## 🔄 更新维护

### 数据备份
```bash
# 备份数据库
mysqldump -u username -p database_name > backup.sql

# 备份源码
zip -r project_backup.zip ./
```

### 系统更新
1. 备份数据和源码
2. 下载新版本覆盖更新
3. 执行数据库迁移脚本
4. 检查系统功能

## 📞 技术支持

### 版本信息
- **当前版本**：v2.0.0
- **更新日期**：2025-11-17
- **PHP要求**：≥ 8.0.0
- **MySQL要求**：≥ 8.0.0

### 新增功能（v2.0.0）
- ✅ **邮件通知系统** - 完整的SMTP邮件服务
- ✅ **场景化通知** - 8种业务场景邮件通知
- ✅ **模板管理** - 在线编辑邮件模板
- ✅ **邮件统计** - 详细的发送数据统计
- ✅ **后台页面** - 完善的管理员界面
- ✅ **批量操作** - 支持批量处理功能

### 文档资源
- [安装指南](install_instructions.md)
- [API文档](docs/api.md)
- [开发手册](docs/development.md)
- [邮件通知指南](EMAIL_NOTIFICATION_GUIDE.md)

### 测试工具
- 小程序API测试：`test_miniprogram_api.php`
- 短信服务测试：`test_sms_service.php`
- 小程序配置检查：`check_miniprogram_settings.php`

## 📄 许可证

本项目基于MIT许可证开源，可自由使用和修改。

## 🤝 贡献

欢迎提交Issue和Pull Request来改进项目。

---

**注意**：生产环境部署前请务删除测试文件：
- `test_miniprogram_api.php`
- `test_sms_service.php`
- `check_miniprogram_settings.php`
- `install.php`（安装完成后删除）